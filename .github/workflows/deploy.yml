name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Setup Tailscale
        env:
          TAILSCALE_OAUTH_CLIENT_ID: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          TAILSCALE_OAUTH_SECRET: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
        run: |
          # Install Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh

          # Start tailscaled
          sudo tailscaled --state=mem: &
          sleep 5

          # Authenticate with OAuth - show full error output
          sudo tailscale up --authkey="${TAILSCALE_OAUTH_CLIENT_ID}?preauthorized=true&ephemeral=true" --advertise-tags=tag:ci 2>&1 || {
            echo "First auth attempt failed, trying with oauth-secret..."
            sudo tailscale up --auth-key="tskey-client-${TAILSCALE_OAUTH_CLIENT_ID}-${TAILSCALE_OAUTH_SECRET}" --advertise-tags=tag:ci 2>&1 || {
              echo "OAuth failed. Checking tailscale status..."
              sudo tailscale status 2>&1 || true
              exit 1
            }
          }

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=accept-new jsp@"$SERVER_HOST" << 'EOF'
            # Stop the server (send Ctrl+C to screen)
            screen -S witcal-prod-server -p 0 -X stuff $'\003'
            sleep 2

            # Pull latest code, run migrations, and restart
            screen -S witcal-prod-server -p 0 -X stuff 'cd /Users/jsp/server/calendar-backend && git pull && RAILS_ENV=production bundle exec rails db:migrate && RAILS_ENV=production rails server\n'
          EOF

      - name: Verify Deployment
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
        run: |
          sleep 5
          ssh jsp@"$SERVER_HOST" "curl -sf http://localhost:3000/up || exit 1"

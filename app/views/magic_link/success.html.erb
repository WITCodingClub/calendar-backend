<% content_for :title, "Sign In Successful - WIT Calendar" %>

<div class="min-h-screen bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center p-5">
  <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-10 text-center">
    <div class="w-20 h-20 mx-auto mb-5 rounded-full bg-emerald-500 flex items-center justify-center animate-[scaleIn_0.3s_ease-out]">
      <svg class="w-12 h-12 stroke-white stroke-[3] animate-[checkmark_0.3s_ease-out_0.3s_both]" viewBox="0 0 52 52" fill="none" stroke-linecap="round">
        <path stroke-dasharray="50" stroke-dashoffset="50" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
      </svg>
    </div>

    <h1 class="text-gray-900 mb-3 text-3xl font-bold">âœ¨ Sign In Successful!</h1>
    <p class="text-gray-600 leading-relaxed mb-4">You're now authenticated with WIT Calendar.</p>
    <p class="bg-gray-100 rounded-lg p-4 mt-6 m-0 text-sm text-emerald-600 font-semibold">
      âœ“ Authenticated as <%= @user.email %>
    </p>

    <div class="bg-gray-100 rounded-lg p-4 mt-6">
      <p id="extension-status" class="m-0 text-sm text-emerald-600 font-semibold">ðŸ”„ Connecting to extension...</p>
    </div>

    <button class="mt-6 px-6 py-3 bg-indigo-500 text-white border-0 rounded-lg text-base font-semibold cursor-pointer transition-all hover:bg-indigo-600" onclick="window.close()">Close this tab</button>

    <% if @user.admin_access? %>
      <a href="<%= admin_root_path %>" class="mt-3 inline-block px-6 py-3 bg-green-500 text-white border-0 rounded-lg text-base font-semibold cursor-pointer transition-all hover:bg-green-600">Go to Admin Dashboard</a>
    <% end %>

    <!-- Hidden token data for extension -->
    <div class="hidden">
      <input type="hidden" id="jwt-token" value="<%= @jwt_token %>">
      <input type="hidden" id="user-email" value="<%= @user.email %>">
      <input type="hidden" id="user-id" value="<%= @user.id %>">
    </div>
  </div>
</div>

<style>
  @keyframes scaleIn {
    from { transform: scale(0); }
    to { transform: scale(1); }
  }
  @keyframes checkmark {
    from { stroke-dashoffset: 50; }
    to { stroke-dashoffset: 0; }
  }
</style>

<script>
    // Send authentication data to Chrome extension
    document.addEventListener('DOMContentLoaded', function() {
      const token = document.getElementById('jwt-token').value;
      const userEmail = document.getElementById('user-email').value;
      const userId = document.getElementById('user-id').value;
      const statusEl = document.getElementById('extension-status');

      const authData = {
        type: 'WIT_CALENDAR_AUTH',
        token: token,
        user: {
          id: userId,
          email: userEmail
        }
      };

      // Try to communicate with extension via postMessage
      // The extension should be listening for this
      try {
        // Attempt 1: Send to window.opener (if opened by extension)
        if (window.opener) {
          window.opener.postMessage(authData, '*');
          statusEl.textContent = 'âœ“ Authentication sent to extension!';
          statusEl.style.color = '#10b981';
        } else {
          // Attempt 2: Send to all frames (extension might inject a listener)
          window.postMessage(authData, '*');
          statusEl.textContent = 'âœ“ Ready for extension to read token';
          statusEl.style.color = '#10b981';
        }

        // Also store in localStorage as a fallback
        localStorage.setItem('wit_calendar_auth', JSON.stringify(authData));

        // Auto-close after 3 seconds if opened by extension
        if (window.opener) {
          setTimeout(() => {
            window.close();
          }, 3000);
        }
      } catch (e) {
        console.error('Error communicating with extension:', e);
        statusEl.textContent = 'âš  Please copy the token manually if needed';
        statusEl.style.color = '#f59e0b';
      }
    });

    // Listen for messages from extension (for handshake)
    window.addEventListener('message', function(event) {
      if (event.data.type === 'WIT_CALENDAR_AUTH_REQUEST') {
        const token = document.getElementById('jwt-token').value;
        const userEmail = document.getElementById('user-email').value;
        const userId = document.getElementById('user-id').value;

        event.source.postMessage({
          type: 'WIT_CALENDAR_AUTH_RESPONSE',
          token: token,
          user: {
            id: userId,
            email: userEmail
          }
        }, event.origin);
      }
    });
</script>

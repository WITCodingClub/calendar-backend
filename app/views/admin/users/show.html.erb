<div class="flex justify-between items-center mb-6">
  <h1 class="text-2xl font-bold">User Details</h1>
  <%= link_to "Back to Users", admin_users_path, class: "glass-button px-4 py-2 rounded text-sm cursor-pointer inline-block" %>
</div>

  <div class="glass-card shadow-lg rounded-lg overflow-hidden">
    <div class="px-6 py-5">
      <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
        <div>
          <dt class="text-sm font-medium text-gray-500">First Name</dt>
          <dd class="mt-1 text-sm text-gray-900"><%= @user.first_name %></dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500">Last Name</dt>
          <dd class="mt-1 text-sm text-gray-900"><%= @user.last_name %></dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500">Email</dt>
          <dd class="mt-1 text-sm text-gray-900"><%= @user.email %></dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500">User ID</dt>
          <dd class="mt-1 flex items-center gap-2">
            <code class="text-sm bg-gray-100 px-2 py-1 rounded font-mono text-gray-700"><%= @user.public_id %></code>
            <button type="button"
                    onclick="navigator.clipboard.writeText('<%= @user.public_id %>'); this.textContent = 'Copied!'; setTimeout(() => this.textContent = 'Copy', 2000);"
                    class="text-xs text-blue-600 hover:text-blue-800 font-medium">
              Copy
            </button>
          </dd>
        </div>

        <% if policy(@user).view_access_level? %>
          <div>
            <dt class="text-sm font-medium text-gray-500">Access Level</dt>
            <dd class="mt-1">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-[#d13732]/10 text-[#d13732]">
                <%= @user.access_level_text %>
              </span>
            </dd>
          </div>
        <% end %>

        <div class="sm:col-span-2">
          <dt class="text-sm font-medium text-gray-500">ICS Calendar URL</dt>
          <dd class="mt-1 flex items-center gap-2">
            <% if @user.calendar_token.present? %>
              <code class="text-xs bg-gray-100 px-2 py-1 rounded font-mono text-gray-700 break-all"><%= @user.cal_url %></code>
              <button type="button"
                      onclick="navigator.clipboard.writeText('<%= @user.cal_url %>'); this.textContent = 'Copied!'; setTimeout(() => this.textContent = 'Copy', 2000);"
                      class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                Copy
              </button>
            <% else %>
              <span class="text-gray-400">No calendar token</span>
            <% end %>
          </dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500">Last Calendar Sync</dt>
          <dd class="mt-1 text-sm text-gray-900">
            <% if @user.last_calendar_sync_at %>
              <span title="<%= @user.last_calendar_sync_at.strftime("%B %d, %Y at %I:%M %p") %>">
                <%= time_ago_in_words(@user.last_calendar_sync_at) %> ago
              </span>
              <% if @user.calendar_needs_sync %>
                <span class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                  Needs Sync
                </span>
              <% end %>
            <% else %>
              <span class="text-gray-400">Never synced</span>
            <% end %>
          </dd>
        </div>

        <div>
          <dt class="text-sm font-medium text-gray-500">Created At</dt>
          <dd class="mt-1 text-sm text-gray-900"><%= @user.created_at.strftime("%B %d, %Y at %I:%M %p") %></dd>
        </div>
      </dl>

      <div class="mt-6 flex gap-3 flex-wrap">
        <% if policy(@user).edit? %>
          <%= link_to "Edit User", edit_admin_user_path(@user), class: "glass-button px-4 py-2 rounded text-sm cursor-pointer inline-block" %>
        <% end %>

        <% if policy(@user).force_calendar_sync? && @user.google_credential&.google_calendar %>
          <%= button_to "Force Calendar Sync", force_calendar_sync_admin_user_path(@user),
            method: :post,
            data: { turbo_confirm: "Force sync calendar for #{@user.email}? This will update all events regardless of changes." },
            class: "glass-button px-4 py-2 rounded text-sm cursor-pointer bg-blue-50/40 text-blue-600" %>
        <% end %>

        <% if policy(@user).destroy? %>
          <%= render "delete_confirmation_modal",
              user: @user,
              button_text: "Delete User",
              button_class: "glass-button px-4 py-2 rounded text-sm cursor-pointer bg-red-600 text-white" %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Feature Flags Section -->
  <% if policy(@user).toggle_support_flag? %>
  <div class="mt-8 glass-card shadow-lg rounded-lg overflow-hidden">
    <div class="px-6 py-5">
      <details class="group">
        <summary class="flex justify-between items-center cursor-pointer list-none">
          <h2 class="text-xl font-bold">Feature Flags</h2>
          <svg class="w-5 h-5 text-gray-500 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </summary>
        
        <div class="mt-4 space-y-3">
          <% env_switcher_enabled = Flipper.enabled?(FlipperFlags::ENV_SWITCHER, @user) %>
          <% debug_mode_enabled = Flipper.enabled?(FlipperFlags::DEBUG_MODE, @user) %>
          
          <div class="flex items-center justify-between py-2">
            <div>
              <h3 class="font-medium text-gray-900">Environment Switcher</h3>
              <p class="text-sm text-gray-500">Allows switching between different environments</p>
            </div>
            <%= button_to toggle_support_flag_admin_user_path(@user, flag: :env_switcher),
                method: :post,
                class: "relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-[#d13732] focus:ring-offset-2 #{env_switcher_enabled ? 'bg-[#d13732]' : 'bg-gray-200'}",
                "aria-checked": env_switcher_enabled,
                role: "switch" do %>
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform <%= env_switcher_enabled ? 'translate-x-6' : 'translate-x-1' %>"></span>
            <% end %>
          </div>
          
          <div class="flex items-center justify-between py-2">
            <div>
              <h3 class="font-medium text-gray-900">Debug Mode</h3>
              <p class="text-sm text-gray-500">Enables debug information and tools</p>
            </div>
            <%= button_to toggle_support_flag_admin_user_path(@user, flag: :debug_mode),
                method: :post,
                class: "relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-[#d13732] focus:ring-offset-2 #{debug_mode_enabled ? 'bg-[#d13732]' : 'bg-gray-200'}",
                "aria-checked": debug_mode_enabled,
                role: "switch" do %>
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform <%= debug_mode_enabled ? 'translate-x-6' : 'translate-x-1' %>"></span>
            <% end %>
          </div>
        </div>
      </details>
    </div>
  </div>
  <% end %>

  <!-- Friends Section -->
  <div class="mt-8 glass-card shadow-lg rounded-lg overflow-hidden">
    <div class="px-6 py-5">
      <details class="group" open>
        <summary class="flex justify-between items-center cursor-pointer list-none">
          <h2 class="text-xl font-bold">Friends (<%= @user.friends.count %>)</h2>
          <svg class="w-5 h-5 text-gray-500 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </summary>

        <div class="mt-4">
          <!-- Add Friend Form -->
          <% if policy(@user).manage_friendships? %>
            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
              <h3 class="text-sm font-medium text-gray-700 mb-2">Add Friend</h3>
              <%= form_with url: add_friend_admin_user_path(@user), method: :post, class: "flex gap-2 items-end" do |f| %>
                <div class="flex-1">
                  <label class="block text-xs text-gray-500 mb-1">Friend's User ID (usr_...)</label>
                  <%= f.text_field :friend_id, placeholder: "usr_abc123", class: "w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#d13732] focus:ring-opacity-50" %>
                </div>
                <%= f.submit "Add Friend", class: "px-4 py-2 text-sm bg-[#d13732] text-white rounded-md hover:bg-[#b82e2a] cursor-pointer" %>
              <% end %>
            </div>
          <% end %>

          <!-- Friends List -->
          <% friends = @user.friends %>
          <% if friends.any? %>
            <div class="space-y-2">
              <% friends.each do |friend| %>
                <div class="flex items-center justify-between py-2 px-3 bg-white rounded border border-gray-200">
                  <div class="flex items-center gap-3">
                    <div>
                      <div class="font-medium text-gray-900"><%= friend.full_name %></div>
                      <div class="text-xs text-gray-500"><%= friend.email %></div>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <code class="text-xs bg-gray-100 px-2 py-1 rounded font-mono text-gray-600"><%= friend.public_id %></code>
                    <%= link_to "View", admin_user_path(friend), class: "text-xs text-blue-600 hover:text-blue-800" %>
                    <% if policy(@user).manage_friendships? %>
                      <%= button_to "Remove", remove_friend_admin_user_path(@user, friend_id: friend.public_id),
                          method: :delete,
                          data: { turbo_confirm: "Remove #{friend.full_name} as a friend?" },
                          class: "text-xs text-red-600 hover:text-red-800" %>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-sm text-gray-500">No friends yet.</p>
          <% end %>

          <!-- Pending Requests -->
          <% incoming = @user.incoming_friend_requests.includes(:requester) %>
          <% outgoing = @user.outgoing_friend_requests.includes(:addressee) %>
          <% if incoming.any? || outgoing.any? %>
            <div class="mt-4 pt-4 border-t border-gray-200">
              <h3 class="text-sm font-medium text-gray-700 mb-2">Pending Requests</h3>

              <% if incoming.any? %>
                <div class="mb-2">
                  <span class="text-xs text-gray-500">Incoming:</span>
                  <% incoming.each do |fr| %>
                    <span class="ml-2 inline-flex items-center gap-1 px-2 py-1 bg-yellow-50 text-yellow-800 text-xs rounded">
                      <%= fr.requester.full_name %>
                      <code class="text-[10px] text-yellow-600"><%= fr.requester.public_id %></code>
                    </span>
                  <% end %>
                </div>
              <% end %>

              <% if outgoing.any? %>
                <div>
                  <span class="text-xs text-gray-500">Outgoing:</span>
                  <% outgoing.each do |fr| %>
                    <span class="ml-2 inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-800 text-xs rounded">
                      <%= fr.addressee.full_name %>
                      <code class="text-[10px] text-blue-600"><%= fr.addressee.public_id %></code>
                    </span>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </details>
    </div>
  </div>

  <!-- OAuth Credentials Section -->
  <% if policy(@user).view_oauth_credentials? && @oauth_credentials.any? %>
    <div class="mt-8 glass-card shadow-lg rounded-lg overflow-hidden">
      <div class="px-6 py-5">
        <h2 class="text-xl font-bold mb-4">OAuth Credentials</h2>
        
        <div class="space-y-4">
          <% @oauth_credentials.each do |credential| %>
            <div class="border border-gray-200 rounded-lg p-4">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-2">
                    <h3 class="text-lg font-medium text-gray-900"><%= credential.email %></h3>
                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                      <%= credential.provider.capitalize %>
                    </span>
                  </div>
                  
                  <dl class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <dt class="font-medium text-gray-500">Created</dt>
                      <dd class="text-gray-900"><%= credential.created_at.strftime("%b %d, %Y") %></dd>
                    </div>
                    <div>
                      <dt class="font-medium text-gray-500">Last Updated</dt>
                      <dd class="text-gray-900"><%= credential.updated_at.strftime("%b %d, %Y") %></dd>
                    </div>
                    <div>
                      <dt class="font-medium text-gray-500">Token Expires</dt>
                      <dd class="text-gray-900">
                        <% if credential.token_expires_at %>
                          <%= credential.token_expires_at.strftime("%b %d, %Y at %I:%M %p") %>
                          <% if credential.token_expires_at < Time.current %>
                            <span class="ml-2 px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Expired</span>
                          <% elsif credential.token_expires_at < 1.day.from_now %>
                            <span class="ml-2 px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Expiring Soon</span>
                          <% end %>
                        <% else %>
                          <span class="text-gray-400">No expiration</span>
                        <% end %>
                      </dd>
                    </div>
                    <div>
                      <dt class="font-medium text-gray-500">Google Calendar</dt>
                      <dd class="text-gray-900">
                        <% if credential.google_calendar %>
                          <span class="text-green-600">âœ“ Connected</span>
                          <div class="text-xs text-gray-500 mt-1">
                            <%= credential.google_calendar.summary %>
                          </div>
                        <% else %>
                          <span class="text-gray-400">Not connected</span>
                        <% end %>
                      </dd>
                    </div>
                  </dl>
                </div>
                
                <div class="ml-4 flex flex-col gap-2">
                  <% if policy(credential).refresh? %>
                    <%= button_to "Refresh Token", refresh_oauth_credential_admin_user_path(@user, credential_id: credential.id),
                        method: :post,
                        class: "text-xs px-3 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 border border-blue-200" %>
                  <% end %>
                  
                  <% if policy(credential).revoke? %>
                    <%= button_to "Revoke", revoke_oauth_credential_admin_user_path(@user, credential_id: credential.id),
                        method: :delete,
                        data: { turbo_confirm: "Are you sure? This will disconnect #{credential.email} from the calendar system." },
                        class: "text-xs px-3 py-1 bg-red-50 text-red-600 rounded hover:bg-red-100 border border-red-200" %>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Enrollments Section -->
  <% if @enrollments_by_term.any? %>
    <div class="mt-8 glass-card shadow-lg rounded-lg overflow-hidden">
      <div class="px-6 py-5">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Enrollments</h2>
          <% if @enrollments_by_term.size > 1 %>
            <select id="enrollments-term-select" class="px-3 py-1 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-opacity-50 bg-white/80 text-[#d13732] border-[rgba(209,55,50,0.3)]">
              <% @enrollments_by_term.keys.each_with_index do |term, index| %>
                <option value="<%= term.id %>" <%= index == 0 ? 'selected' : '' %>><%= term.name %></option>
              <% end %>
            </select>
          <% end %>
        </div>
        
        <div id="enrollments-container">
          <% @enrollments_by_term.each_with_index do |(term, enrollments), index| %>
            <div class="enrollment-term <%= index > 0 ? 'hidden' : '' %>" data-term-id="<%= term.id %>">
            
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Instructor</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Credits</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Schedule</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <% enrollments.each do |enrollment| %>
                    <tr>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <% if enrollment.course %>
                          <%= enrollment.course.subject %> <%= enrollment.course.course_number %>
                          <% if enrollment.course.section_number.present? %>
                            <span class="text-gray-500">(<%= enrollment.course.section_number %>)</span>
                          <% end %>
                        <% else %>
                          <span class="text-gray-400">Course not found</span>
                        <% end %>
                      </td>
                      <td class="px-6 py-4 text-sm text-gray-900">
                        <% if enrollment.course %>
                          <%= titleize_with_roman_numerals(enrollment.course.title) %>
                        <% else %>
                          <span class="text-gray-400">--</span>
                        <% end %>
                      </td>
                      <td class="px-6 py-4 text-sm text-gray-900">
                        <% if enrollment.course&.faculties&.any? %>
                          <%= enrollment.course.faculties.map(&:display_name).join(", ") %>
                        <% else %>
                          <span class="text-gray-400">No instructor</span>
                        <% end %>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <% if enrollment.course&.credit_hours %>
                          <%= enrollment.course.credit_hours %>
                        <% else %>
                          <span class="text-gray-400">--</span>
                        <% end %>
                      </td>
                      <td class="px-6 py-4 text-sm text-gray-900">
                        <% if enrollment.course&.meeting_times&.any? %>
                          <% enrollment.course.filtered_meeting_times.each do |mt| %>
                            <div class="mb-1 last:mb-0">
                              <% if mt.day_of_week.present? %>
                                <span class="font-medium"><%= mt.day_of_week.capitalize %></span>
                                <% if mt.begin_time && mt.end_time %>
                                  <%= mt.formatted_time_range %>
                                <% end %>
                                <% if mt.building_room.present? %>
                                  <span class="text-gray-500">(<%= mt.building_room %>)</span>
                                <% end %>
                              <% end %>
                            </div>
                          <% end %>
                        <% else %>
                          <span class="text-gray-400">No schedule</span>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const enrollmentsTermSelect = document.getElementById('enrollments-term-select');
    if (enrollmentsTermSelect) {
      enrollmentsTermSelect.addEventListener('change', function() {
        const selectedTermId = this.value;
        
        // Hide all enrollment terms
        document.querySelectorAll('.enrollment-term').forEach(function(term) {
          term.classList.add('hidden');
        });
        
        // Show selected enrollment term
        const selectedTerm = document.querySelector(`.enrollment-term[data-term-id="${selectedTermId}"]`);
        if (selectedTerm) {
          selectedTerm.classList.remove('hidden');
        }
      });
    }
  });
  </script>

  <!-- Week Calendar View -->
  <% if @enrollments_by_term.any? %>
    <div class="mt-6">
      <%= render "week_calendar", terms: @enrollments_by_term.keys, enrollments_by_term: @enrollments_by_term %>
    </div>
  <% end %>
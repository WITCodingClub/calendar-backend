<div class="container mx-auto px-4 py-8">
  <div class="mb-6">
    <%= link_to "← Back to Admin", admin_root_path, class: "text-sm font-medium hover:underline", style: "color: #d13732;" %>
  </div>

  <h1 class="text-2xl font-bold mb-6">Course Catalog Fetcher</h1>

  <!-- Instructions Card -->
  <div class="shadow-lg rounded-lg mb-6" style="background: rgba(59, 130, 246, 0.15); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border-left: 4px solid #3b82f6;">
    <div class="p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5" style="color: #2563eb;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3 flex-1">
          <h3 class="text-sm font-medium mb-2" style="color: #1e40af;">How to Get Authentication Cookies</h3>
          <div class="text-sm" style="color: #1e3a8a;">
            <p class="mb-3 font-medium">
              The required cookie (JSESSIONID) is <strong>HttpOnly</strong> for security, so you need to extract it manually from your browser's DevTools:
            </p>

            <ol class="list-decimal list-inside space-y-2">
              <li>
                Navigate to <a href="https://selfservice.wit.edu/StudentRegistrationSsb/ssb/registration" target="_blank" class="underline font-medium">WIT Self-Service Portal</a> and make sure you're logged in
              </li>
              <li>Open your browser's Developer Tools (Press <kbd class="px-1 py-0.5 bg-gray-200 rounded text-xs">F12</kbd> or <kbd class="px-1 py-0.5 bg-gray-200 rounded text-xs">Cmd+Option+I</kbd>)</li>
              <li>Click on the <strong>Application</strong> tab (in Chrome/Edge) or <strong>Storage</strong> tab (in Firefox)</li>
              <li>In the left sidebar, expand <strong>Cookies</strong> and click on <strong>https://selfservice.wit.edu</strong></li>
              <li>You'll see a table of cookies. Find the <strong>JSESSIONID</strong> cookie and copy its <strong>Value</strong>:
                <ul class="ml-6 mt-2 space-y-1 list-disc text-xs">
                  <li><strong>JSESSIONID</strong> (Required) - Usually a short alphanumeric string</li>
                  <li><strong>IDMSESSID</strong> (Optional) - Usually a long hexadecimal string - some endpoints may work without this</li>
                </ul>
              </li>
              <li class="mt-2">Paste the cookie value(s) into the form below and submit immediately (cookies expire quickly!)</li>
            </ol>

            <div class="mt-3 p-3 rounded" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2);">
              <p class="text-xs font-semibold" style="color: #991b1b;">
                ⚠️ Note: These cookies expire after your session ends. You'll need to get fresh cookies for each fetch operation.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fetch Form -->
  <div class="max-w-2xl">
    <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-6" style="background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(209, 55, 50, 0.3);">
      <div class="px-6 py-6">
        <%= form_with(url: admin_course_catalog_fetch_path, method: :post, class: "space-y-6", data: { turbo: false }) do |f| %>
          <div>
            <%= label_tag :term, "Term", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= select_tag :term,
                options_from_collection_for_select(@terms, :uid, ->(term) { "#{term.name} (#{term.uid})" }, params[:term]),
                prompt: "Select a term...",
                required: true,
                class: "w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-opacity-50",
                style: "background: rgba(255, 255, 255, 0.8);" %>
            <p class="mt-1 text-xs text-gray-600">
              Select the term to fetch courses for
            </p>
          </div>

          <div>
            <%= label_tag :jsessionid, "JSESSIONID", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= text_field_tag :jsessionid, nil,
                placeholder: "Paste JSESSIONID value here",
                required: true,
                class: "w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-opacity-50 font-mono text-xs",
                style: "background: rgba(255, 255, 255, 0.8);" %>
          </div>

          <div>
            <%= label_tag :idmsessid, "IDMSESSID (Optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= text_field_tag :idmsessid, nil,
                placeholder: "Paste IDMSESSID value here (optional)",
                required: false,
                class: "w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-opacity-50 font-mono text-xs",
                style: "background: rgba(255, 255, 255, 0.8);" %>
            <p class="mt-1 text-xs text-gray-600">
              Some API endpoints may work without IDMSESSID
            </p>
          </div>

          <div>
            <%= button_tag type: "submit", class: "glass-button px-6 py-2 rounded inline-flex items-center" do %>
              <svg class="mr-2 -ml-1 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
              Fetch Course Catalog
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Results Section -->
  <% if @raw_response.present? %>
    <div class="mt-8">
      <% if @total_count > 0 %>
        <!-- Warning if term already imported -->
        <% if @term_already_imported %>
          <div class="shadow-lg rounded-lg mb-4" style="background: rgba(251, 146, 60, 0.15); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border-left: 4px solid #f97316;">
            <div class="p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <svg class="h-5 w-5" style="color: #ea580c;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                  </svg>
                </div>
                <div class="ml-3">
                  <h3 class="text-sm font-medium" style="color: #c2410c;">⚠️ Term Already Imported</h3>
                  <div class="mt-2 text-sm" style="color: #9a3412;">
                    <p>
                      This term (<strong><%= @term_record.name %></strong>) was previously imported on
                      <strong><%= @term_imported_at.strftime("%B %d, %Y at %I:%M %p") %></strong>.
                    </p>
                    <p class="mt-2">
                      Processing again will <strong>update existing courses</strong> and <strong>add any new courses</strong>.
                      This is safe to do if courses have been added or modified since the last import.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <div class="shadow-lg rounded-lg mb-4" style="background: rgba(34, 197, 94, 0.15); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border-left: 4px solid #22c55e;">
          <div class="p-4">
            <h3 class="text-lg font-semibold mb-2" style="color: #15803d;">
              ✓ Successfully Fetched <%= @total_count %> Courses
            </h3>
            <p class="text-sm mb-3" style="color: #166534;">
              The course catalog has been fetched. You can now process these courses into the database.
            </p>
            <%= form_with(url: admin_course_catalog_import_path, method: :post, data: { turbo: false }) do |f| %>
              <%= f.hidden_field :courses, value: @courses.to_json %>
              <%
                confirm_message = if @term_already_imported
                  "⚠️ This term was already imported on #{@term_imported_at.strftime('%B %d, %Y')}. Processing again will update existing courses and add new ones. Continue?"
                else
                  "This will process #{@total_count} courses into the database. This may take several minutes. Continue?"
                end
              %>
              <%= button_tag type: "submit", class: "glass-button px-6 py-2 rounded inline-flex items-center", data: { confirm: confirm_message } do %>
                <svg class="mr-2 -ml-1 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" />
                </svg>
                <% if @term_already_imported %>
                  Re-process <%= @total_count %> Courses (Update)
                <% else %>
                  Process <%= @total_count %> Courses into Database
                <% end %>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>

      <div class="mt-4 shadow-lg rounded-lg overflow-hidden" style="background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(209, 55, 50, 0.3);">
        <div class="px-6 py-4">
          <div class="mb-4">
            <h4 class="text-sm font-semibold text-gray-700 mb-2">API Response (first page):</h4>
            <pre class="px-4 py-3 rounded overflow-x-auto text-xs" style="background: rgba(0, 0, 0, 0.05); max-height: 400px; overflow-y: auto;"><code><%= JSON.pretty_generate(@raw_response) %></code></pre>
          </div>

          <% if @courses.present? && @total_count > 0 %>
            <div class="mb-4">
              <h4 class="text-sm font-semibold text-gray-700 mb-2">Sample Courses (first 3):</h4>
              <pre class="px-4 py-3 rounded overflow-x-auto text-xs" style="background: rgba(0, 0, 0, 0.05); max-height: 400px; overflow-y: auto;"><code><%= JSON.pretty_generate(@courses.first(3)) %></code></pre>
            </div>
          <% end %>

          <div class="mt-4 text-sm text-gray-600">
            <p class="font-medium">Total courses fetched: <%= @total_count %></p>
            <% if @total_count == 0 %>
              <p class="mt-2 text-yellow-700 font-medium">⚠️ The API returned 0 courses. Check the raw response above for error messages or authentication issues.</p>
            <% else %>
              <p class="mt-2">You can now use this data to process courses into the database or perform other operations.</p>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
